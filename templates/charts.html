{% extends "layout.html" %}
{% block content %}

<style>
    .table {
    max-width: 100%;
    background-color: transparent;
    border-collapse: collapse;
    border-spacing: 0;
    }

    .table-bordered {
        border: 1px solid #ddd;
        border-collapse: separate;
        -moz-border-radius: 4px;
        border-radius: 4px;
    }
    .doughnut-graph {
       border-style: solid;
       border-width: 5px;
    }

    .templates {
       display: none !important;
    }


    .checkboxes {
        float: left;
        background-color: #ddd;
        padding: 5px;
    }

    .fixed-height-overflow {
        height: 411px;
        overflow-y: scroll;

    }

</style>

<div class="checkboxes" name="checkboxes">
    Roll up by:<br>
    <input type="checkbox" name="checkboxGroup" class="points-checkbox" id="r1" value="Total points">Total points<br>
    <input type="checkbox" name="checkboxGroup"  class="points-checkbox2" id="r2" value="Total ships">Total ships
</div>

<div class="templates">
    <div class="doughnut-graph" style="width: 600px; height: 400px; margin: 0 auto"></div>
</div>

<div id="doughnuts" class="fixed-height-overflow">
    <div id="faction-ship"></div>
</div>


<script>
$('.points-checkbox').change(function() {
    console.log("fired");
    var $this = $(this);
    // $this will contain a reference to the checkbox
    var doughtnutFactionDiv = $('#doughnuts #faction-ship')

    if ($this.is(':checked')) {
        console.log("checked")
        var newDiv = $('.templates .doughnut-graph').clone();
        doughtnutFactionDiv.append( newDiv );
            var url = "/get_chart_data";

            $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    url: url,
                    data: JSON.stringify({ data: { 'checked' : this.checked, 'value' : this.value, 'name': this.name }  } ),
                    success: function (data) {
                        var factions = data['data']
                        var colors = Highcharts.getOptions().colors;
                        console.log(factions[0])

                        factions[ 0 ].color = colors[0];
                        factions[ 0 ].drilldown.color = colors[0];
                        factions[ 1 ].color = colors[1];
                        factions[ 1 ].drilldown.color = colors[1];
                        var faction_categories = [ factions[ 0 ].drilldown.name, factions[ 1 ].drilldown.name ];



                        _.each( factions, function(faction) {
                            if  ( faction.drilldown.faction == 'Rebel' )
                            {
                                faction.color = colors[0];
                            }
                            else if ( faction.drilldown.faction == "Imperial")
                            {
                                faction.color = colors[1];
                            }
                        });

                        makeDonutGraph( factions, faction_categories, "Faction-Ship Breakout", "Factions", "Ships", newDiv );

                    },
                    dataType: "json"
            });


    } else {
        doughtnutFactionDiv.empty();
        console.log("not checked")
    }
});
</script>

{#
$(document).ready(function () {
    $("input[name=radioGroup]:radio").change(function () {
        if ($("#r1").attr("checked")) {
            var url = "/get_chart_data";

            $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    url: url,
                    data: JSON.stringify({ data: { 'checked' : this.checked, 'value' : this.value, 'name': this.name }  } ),
                    success: function (data) {
                        var factions = data['data']
                        var colors = Highcharts.getOptions().colors;
                        console.log(factions[0])

                        factions[ 0 ].color = colors[0];
                        factions[ 0 ].drilldown.color = colors[0];
                        factions[ 1 ].color = colors[1];
                        factions[ 1 ].drilldown.color = colors[1];
                        var faction_categories = [ factions[ 0 ].drilldown.name, factions[ 1 ].drilldown.name ];



                        _.each( factions, function(faction) {
                            if  ( faction.drilldown.faction == 'Rebel' )
                            {
                                faction.color = colors[0];
                            }
                            else if ( faction.drilldown.faction == "Imperial")
                            {
                                faction.color = colors[1];
                            }
                        });

                        var doughnutDiv = $('.doughnut-graph.template').clone().removeClass('template').append('.doughnuts')
                        $(doughnutDiv).attr("id", "container1");
                        console.log(doughnutDiv);
                        makeDonutGraph( factions, faction_categories, "Faction-Ship Breakout", "Factions", "Ships", "#container1" );

                    },
                    dataType: "json"
            });
        }
        else {
            $('#container1').remove()
        }
        $('#log').val($('#log').val()+ $(this).val() + '|');
    })
});
#}


<script>



    function makeDonutGraph( data, data_categories, title, level1Name, level2Name,  containerName ) {
        var level1Data = [],
            level2Data = [],
            i,
            j,
            dataLen = data.length,
            drillDataLen,
            brightness;


        // Build the factions arrays
        for (i = 0; i < dataLen; i += 1) {

            // add browser factions
            level1Data.push({
                name: data_categories[i],
                y: data[i].y,
                color: data[i].color
            });



            // add version factions
            drillDataLen = data[i].drilldown.data.length;
            for (j = 0; j < drillDataLen; j += 1) {
                brightness = 0.2 - (j / drillDataLen) / 5;
                level2Data.push({
                    name: data[i].drilldown.categories[j],
                    y: data[i].drilldown.data[j],
                    color: Highcharts.Color(data[i].color).brighten(brightness).get()
                });
            }
        }


        // Create the chart
        containerName.highcharts({
            chart: {
                type: 'pie'
            },
            title: {
                text: title
            },
            yAxis: {
                title: {
                    text: 'Total percent usage'
                }
            },
            plotOptions: {
                pie: {
                    shadow: false,
                    center: ['50%', '50%']
                }
            },
            tooltip: {
                valueSuffix: '%'
            },
            series: [{
                name: level1Name,
                data: level1Data,
                size: '60%',
                dataLabels: {
                    formatter: function () {
                        return this.y >= 5 ? this.point.name : null;
                    },
                    color: 'white',
                    distance: -30
                }
            }, {
                name: level2Name,
                data: level2Data,
                size: '80%',
                innerSize: '60%',
                dataLabels: {
                    formatter: function () {
                        // display only if larger than 1
                        return this.y > 1 ? '<b>' + this.point.name + ':</b> ' + this.y + '%'  : null;
                    }
                }
            }]
        });
    }


    $( document ).ready(init );

    function init() {
        var vt = $('.points-checkbox');
        console.log("checking the box");
        vt.prop( "checked", true).change();
        console.log("checked it");
    }

</script>




{% endblock %}