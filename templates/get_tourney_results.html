{% extends "layout.html" %}
{% block content %}

<style>
    .template {
        display: none !important;
    }

    .hidden {
        display: none;
    }

    label {
        display: inline-block;
        margin-bottom: 5px;
        font-weight: bold;
    }


    .btn {
        display: inline-block;
        padding: 6px 12px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: normal;
        line-height: 1.428571429;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -o-user-select: none;
        user-select: none;
    }

    .btn-info {
        margin-top: 10px;
        color: #ffffff;
        background-color: #3882C7;
        border-color: #46b8da;
    }
</style>

<div id="templates" name="templates">
    <div data-row-span="7" class="data-row-span"></div>
    <div data-field-span="1" class="data-field-span"></div>
    <input type="text" class="data-input template"/>
    <div class="radio-input template">
        <input type="radio" value="1">Yes
        <input type="radio" value="0" checked="checked">No
    </div>
</div>

<script>
var editor; // use a global for the submit and return data rendering in the examples


$(document).ready(function() {
    // Create or update the todo localStorage entry
    if ( !localStorage.getItem('datatable_todo') ) {
        localStorage.setItem('datatable_todo', '[]');
    }
    else {
        // Loop over the array, removing any nulls from previous deletes on init
        var a = JSON.parse( localStorage.getItem('datatable_todo') );
        for ( var i=a.length-1 ; i>=0 ; i-- ) {
            if ( a[i] === null ) {
                a.splice( i, 1 );
            }
        }
        localStorage.setItem('datatable_todo', JSON.stringify(a));
    }

    // Set up the editor
    editor = new $.fn.dataTable.Editor( {
        table: "#example",
        fields: [ {
                label: "Item:",
                name: "item"
            }, {
                label: "Status:",
                name: "status"
        }
        ],
        ajax: function ( method, url, data, successCallback, errorCallback ) {
            var id = null;
            var store = JSON.parse( localStorage.getItem('datatable_todo') );

            if ( data.action === 'create' ) {
                store.push( {
                    "DT_RowId": 'row_'+store.length,
                    "item": data.data.item,
                    "status": data.data.status
                } );
                id = 'row_'+(store.length-1);
            }
            else if ( data.action === 'edit' ) {
                var index = findIndex( store, data.id );
                store[index].item = data.data.item;
                store[index].status = data.data.status;
                id = data.id;
            }
            else if ( data.action === 'remove' ) {
                for ( var i=0, iLen=data.id.length ; i<iLen ; i++ ) {
                    var index = findIndex( store, data.id[i] );
                    if ( index >= 0 ) {
                        store[index] = null; // Don't upset the indexes
                    }
                }
            }

            localStorage.setItem('datatable_todo', JSON.stringify(store));
            successCallback( {"id": id} );
        }
    } );

    // Activate an inline edit on click of a table cell
    $('#example').on( 'click', 'tbody td:not(:first-child)', function (e) {
        editor.inline( this );
    } );

    // Initialise the DataTable
    var t = $('#example').dataTable( {
        dom: "Tfrtip",
        data: JSON.parse( localStorage.getItem('datatable_todo') ),
        columns: [
            { data: "item" },
            { data: "status" }
        ],
        tableTools: {
            sRowSelect: "os",
             sRowSelector: 'td:first-child',
            aButtons: [
                { sExtends: "editor_create", editor: editor },
                { sExtends: "editor_edit",   editor: editor },
                { sExtends: "editor_remove", editor: editor }
            ]
        }
    } );
{#    for( var counter = 1; counter < 2; counter++ ) {#}
{#        t.row.add( [ "foo", "bar" ] );#}
{##}
{#    }#}
{#    t.draw();#}


} );

function findIndex( store, id ) {
    for ( var i=0, iLen=store.length ; i<iLen ; i++ ) {
        if ( store[i] && store[i].DT_RowId === id ) {
            return i;
        }
    }
    return -1;



}
</script>

<table id="example" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Item</th>
                <th>Status</th>
            </tr>
        </thead>

    </table>

<form id="form"
      class="grid-form"
      action="{{ url_for('add_tourney_results') }}"
      method=POST
      class="add-entry"
      enctype="multipart/form-data"
      data-parsley-validate >
    <input name="num_players" id="num_players" type="text" class="hidden"/>
    <input name="tourney_id" value="{{ tourney_id }}" type="text" class="hidden">

    <fieldset id="fieldset" name="fieldset">
        <legend>Player results</legend>
        <div data-row-span="7" >
            <div data-field-span="1" id="player-name">
                <label>Player name</label>
            </div>
            <div data-field-span="1" id="points-scored">
                <label>Total Points scored</label>
            </div>
            <div data-field-span="1" id="swiss-rank">
                <label>Swiss Rank</label>
            </div>
            <div data-field-span="1" id="player-dropped">
                <label>Did Player Drop?</label>
            </div>
            <div data-field-span="1" id="elimination-rank">
                <label>Championship Bracket Rank (optional) </label>
            </div>
            <div data-field-span="1" id="mov">
                <label>Margin of Victory (optional)</label>
            </div>
            <div data-field-span="1" id="sos">
                <label>Strength of Schedule (optional) </label>
            </div>
        </div>
        <div data-row-span="7" name="data-row-span" id="first-data-row-span">
            <div data-field-span="1">
                <input type="text" name="player_name_1" required/>
            </div>
            <div data-field-span="1">
                <input type="text" name="score_1" data-parsley-type="integer" required/>
            </div>

            <div data-field-span="1">
                <input type="text" name="pre_elim_1" data-parsley-type="integer" required/>
            </div>
            <div data-field-span="1">
                <div>
                    <input type="radio" name="dropped_1" value="1">Yes
                    <input type="radio" name="dropped_1" value="0" checked="checked">No
                </div>
            </div>

            <div data-field-span="1">
                <input type="text" name="elim_1" data-parsley-type="integer"/>
            </div>


            <div data-field-span="1">
                <input type="text" name="mov_1" data-parsley-type="integer" />
            </div>
            <div data-field-span="1">
                <input type="text" name="sos_1" data-parsley-type="integer" />
            </div>
        </div>
    </fieldset>
    <br>
    <button type="button" class="btn btn-info validate " onclick="addRow()">Add anther row</button>
    <input type="submit" class="btn btn-info validate" />

</form>


<script>
    $('#form').parsley();
    var rowCount = 1;
    var currentFieldSetDiv = $('#first-data-row-span');
</script>

<script>

var inputs    = [ 'player_name',  'score',  'pre_elim', 'dropped', 'elim', 'mov',   'sos']
var required =  [ true,            true,    true,      true,       false,  false,  false]

var droppedIndex = 3;

function addRow() {
    rowCount++;
    var dataRowEl       = $('#templates .data-row-span').clone(true).removeClass('template');
    currentFieldSetDiv.after(dataRowEl);
    for ( i = 0; i < inputs.length; i++ ) {
        var dataFieldSpanEL = $('#templates .data-field-span').clone(true).removeClass('template');
        dataRowEl.append(dataFieldSpanEL);

        //special processing for the stoopid dropped radio button :-(
        if ( i == droppedIndex ) {
            var radioDivEl = $('#templates .radio-input').clone(true).removeClass('template');
            //set the name for both of the two radio inputs inside the div
            radioDivEl.children().attr("name", inputs[i] + "_" + rowCount.toString() );
            dataFieldSpanEL.append( radioDivEl );
        }
        else {
            var inputEl         = $('#templates .data-input').clone(true).removeClass('template');
            inputEl.attr("name", inputs[i] + "_" + rowCount.toString() );
            if ( required[i] == true ) {
                inputEl.attr("required", ""); //javascript is weird.
            }
            dataFieldSpanEL.append(inputEl);
        }
        $('#num_players').val( rowCount );
    }
    currentFieldSetDiv = dataRowEl;

}
</script>

<script type="text/javascript">
  $(document).ready(function() {
    Tipped.create('#player-name',  "The full name of the participating player", {position: 'topright'} )
    Tipped.create('#points-scored', "Sum of points scored by player (full win:5, modified: 3, draw: 1)", { position: 'topright' } );
    Tipped.create('#player-dropped', "If the player dropped, set this to true", { position: 'topright' } );
    Tipped.create('#swiss-rank', "The player's final ranking in the swiss rounds; winner is 1, second place is 2, etc", { position: 'topright' } );
    Tipped.create('#elimination-rank', "The player's final Championship Round place", { position: 'topright' } );
    Tipped.create('#mov', "The player's final margin of victory", { position: 'topright' } );
    Tipped.create('#sos', "The player's final strength of schedule", { position: 'topright' } );
  } );
</script>


{% endblock %}
