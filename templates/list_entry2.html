{% extends "layout.html" %}
{% block content %}

    <script>
        var entryCount = 0;
        var ships_and_pilots = {{ meta.ships_full()|tojson|safe }}
        var upgrades         = {{ meta.upgrades()|tojson|safe }}
    </script>

    <style>

        .squad {
            display: none;
        }

        .squad-member {
            width: 350px;
            background-color: #ddd;
            margin: 10px;
            padding: 20px;
        }

        .row {
            margin: 5px 0;
        }

        .row-label {
            display: inline-block;
            width: 100px;
            text-align: right;
            font-weight: bold;
        }

        .row-value {
            display: inline-block;
            width: 150px;
        }

        .row-value .select {
            width: 200px;
        }

        .row-cost {
            display: inline-block;
            width: 20px;
            text-align: right;
        }

        .sub-total {
            text-align: right;
            margin-left: 258px;
            width: 20px;
            border-top: 1px solid #000;
        }

        .total {
            text-align: right;
            margin-left: 288px;
            width: 20px;
            border-top: 1px solid #000;
            font-weight: bold;
        }

        .template {
            display: none !important;
        }

        .add-squad-member {

        }
    </style>
    <div class="main-section">

        <div class="choose-faction">
            Faction?
            <button class="faction-choice">Imperial</button>
            <button class="faction-choice">Rebel</button>
        </div>

        <div class="squad">
            <h2 class="faction-label"></h2>
            <div class="squad-member template">
                <div class="row template">
                    <span class="row-label"></span>
                    <span class="row-value"><div class="select"></div></span>
                    <span class="row-cost"></span>
                </div>
                <div class="sub-total"></div>
            </div>
            <div class="total"></div>
            <button class="add-squad-member">Add squad member</button>
        </div>

    </div>

    <script>

        function init() {
            $('.faction-choice').click(factionChosen);
        }

        function factionChosen() {
            var faction = $(this).text();
            $('.choose-faction').hide();
            $('.squad').show();
            $('.faction-label').text(faction);
            $('.add-squad-member').click(function() { addSquadMember(faction) });
            addSquadMember(faction);
            updateTotals();
        }

        function addSquadMember(faction) {
            var squadMemberEl = $('.squad-member.template').clone().removeClass('template').appendTo('.squad');
            var ships = _.keys(ships_and_pilots).filter(function(ship) { return ships_and_pilots[ship][0].faction == faction });
            var items = ships.map(function (ship) {
                return { text: ship, id: ship }
            });
            addRow(squadMemberEl, 'ship', 'Ship', items, function(ship) { shipChosen(faction, squadMemberEl, ship) });
            updateTotals();
        }


        function removeUpgrades( squadMemberEl ) {
            squadMemberEl.find('.upgrade').each(function(i, upgrade) {  $(upgrade).remove(); });

        }
        function removePilot( squadMemberEl ) {
            squadMemberEl.find('.pilot').each(function(i, pilot) {  $(pilot).remove(); });

        }


        function getShipForSquadMember( squadMemberEl )
        {
            var shipName = squadMemberEl.find( '.ship .row-value .select').select2('data').text;
            return shipName;
        }

        function getPilotHref( shipName, pilotName )
        {
            return _.select(ships_and_pilots[shipName], function(p) { return p.name == pilotName })[0]
        }

        function getUniqueSelectedPilots( squadMemberEl )
        {
            var ret = {};
            //get all the pilots, and cherry pick out hte ones that arent for this squad member
            var pilots = $('.pilot').filter(function(i, pilot) {
               if ( pilot != null ) {
                   pilotEl = $(pilot);
                   var parentSquad = pilotEl.parent();
                   if ( ! parentSquad.is( squadMemberEl ) ) {
                       var pilotSelect =  pilotEl.find('.row-value .select');
                       if ( pilotSelect != null ) {
                           var pilotName = pilotSelect.select2('data').text;
                           //get the ship for the pilot
                           var shipName = getShipForSquadMember( parentSquad );
                           var pilotHref =  getPilotHref(shipName, pilotName );
                           if ( pilotHref != null && 'constraints' in pilotHref ) {
                               var constraints = pilotHref.constraints;
                               _.each(constraints, function (u) {
                                   if (u.type == 'PER_SQUAD' && u.value == 'UNIQUE')
                                   {
                                       ret[pilotHref.name] = pilotHref.name;
                                   }
                               });
                           }
                       }
                   }
               }
            });
            return ret;

        }

        function shipChosen(faction, squadMemberEl, ship) {
            removePilot(squadMemberEl);
            removeUpgrades(squadMemberEl);

            var pilotItems = ships_and_pilots[ship].map(function(pilot) { return { text:pilot.name, id:pilot.name, cost:pilot.cost }});

            //remove any pilots that are unique and have already been selected
            var uniqueSelectedPilots = getUniqueSelectedPilots(squadMemberEl);
            //remove the unique selected pilots from the pilotItems
            pilotItems = _.filter( pilotItems, function (pi) { return ! ( pi.text in uniqueSelectedPilots ) } );

            addRow(squadMemberEl, 'pilot', 'Pilot', pilotItems, function(pilot) { pilotChosen(faction, squadMemberEl, ship, pilot) });
            updateTotals();
        }

        function manageConstraints( constraints, faction  )
        {
            _.each(constraints, function (u) {
                //console.log(u);
                var defaultEntry = {text: u.name, id: u.name, cost: u.cost, disabled: true};
                //todo  ,  , SMALL_SHIP, LARGE_SHIP,PER_SQUAD,UNIQUE
                //done FACTION SHIP_SIZE SHIP_TYPE
                if (u.type == 'FACTION') {
                    if (u.value != faction) {
                        return defaultEntry;
                    }
                }
                else if (u.type == 'SHIP_SIZE') {
                    if (u.value != pilotHref.ship_size) {
                        return defaultEntry;
                    }
                }
                else if (u.type == 'SHIP_TYPE') {
                    if (u.value != ship) {
                        return defaultEntry;
                    }
                }
                //else if (u.type == 'UNIQUE') {
                //    //others. ..
               // }
                else {
                    return {text: u.name, id: u.name, cost: u.cost};
                }
            } );
        }

        function pilotChosen(faction, squadMemberEl, ship, pilot)
        {
            removeUpgrades(squadMemberEl);
            var pilotHref = getPilotHref( ship, pilot );
            var upgrades_for_pilot = pilotHref.upgrades;
            upgrades_for_pilot.forEach(function(upgrade) {
                var upgradeItems = upgrades[upgrade].map(function(u) {

                    if (_.has(u, 'constraints') )
                    {
                        //console.log( u );
                        //console.log( upgrade);
                        return manageConstraints( u.constraints, faction );
                    }
                    else
                    {
                        return {text: u.name, id: u.name, cost: u.cost};
                    }
                } );

                upgradeItems = _.filter( upgradeItems, function(ui) { return _.has(ui, 'disabled') && ui.disabled != true} );

                addRow(squadMemberEl, 'upgrade', upgrade, upgradeItems, function(upgradeValue) {
                    upgradeChosen(squadMemberEl, ship, pilot, upgrade, upgradeValue);
                });
            } );

            updateTotals();
        }

        function upgradeChosen(squadMemberEl, ship, pilot, upgradeName, upgradeValue) {
            updateTotals();
        }

        function addRow(parentEl, className, label, items, changeHandler)
        {
            var rowEl = parentEl.find('.row.template').clone().removeClass('template').appendTo(parentEl);
            rowEl.addClass(className);
            rowEl.find('.row-label').text(label);
            rowEl.find('.row-value .select')
                    .select2({data:items, placeholder:'select a ' + label})
                    .on('select2-close', function(e) {
                        changeHandler(e.target.value);
                    });
        }


        function updateTotals()
        {

            var squadTotal = 0;
            $('.squad-member').not('.template').each(function(i, member) {
                var memberCost = 0;
                var memberEl = $(member);

                var pilot = memberEl.find('.pilot');
                pilotSelect =  pilot.find('.row-value .select');
                if ( pilotSelect != null ) {
                    memberCost     = pilotSelect.select2('data').cost || 0;
                    pilot.find( '.row-cost').text( memberCost );

                    //get all the upgrades
                    var upgradeCosts = 0;
                    memberEl.find('.upgrade').each( function(k, upgrade) {
                        var upgradeEl     = $(upgrade);
                        var upgradeSelect = upgradeEl.find('.row-value .select');
                        if ( upgradeSelect != null ) {
                            var upgradeSelectEl = $(upgradeSelect).select2('data');
                            if ( upgradeSelectEl != null ) {
                                upgradeCosts += upgradeSelectEl.cost;
                                upgradeEl.find('.row-cost').text(upgradeSelectEl.cost);
                            }
                        }
                    } ) ;
                }

                memberCost += upgradeCosts;
                memberEl.find('.sub-total').text( memberCost );
                squadTotal += memberCost;

            });
            $('.total').text(squadTotal);
        }

        init();
    </script>
{% endblock %}
